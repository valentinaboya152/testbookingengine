{% extends "main.html" %}

{% block content %}
<div class="container mt-4" style="max-width: 500px;">
    <h2>Editar Fechas de la Reserva #{{ booking.id }}</h2>

    <!-- Block of messages from server -->
    {% if messages %}
        <div class="mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} mt-2" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="mx-auto" style="max-width: 250px;">
        <form method="post" class="mt-4" id="dateForm">
            {% csrf_token %}

            <div class="form-group">
                <label for="{{ form.checkin.id_for_label }}">Fecha de Entrada:</label>
                {{ form.checkin }}
                {% if form.checkin.errors %}
                    <div class="alert alert-danger mt-2">{{ form.checkin.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group mt-3">
                <label for="{{ form.checkout.id_for_label }}">Fecha de Salida:</label>
                {{ form.checkout }}
                {% if form.checkout.errors %}
                    <div class="alert alert-danger mt-2">{{ form.checkout.errors }}</div>
                {% endif %}
            </div>

            <!-- Error dinámico (JS) -->
            <div id="date-error" class="alert alert-danger mt-2" style="display: none;"></div>

            <button type="submit" class="btn btn-primary mt-4">Guardar</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkin = document.getElementById('{{ form.checkin.auto_id }}');
    const checkout = document.getElementById('{{ form.checkout.auto_id }}');
    const form = document.getElementById('dateForm');
    const errorDiv = document.getElementById('date-error');

    // ⚙️ Función de validación local
    function validateDates() {
        if (checkin.value && checkout.value) {
            if (new Date(checkout.value) <= new Date(checkin.value)) {
                errorDiv.textContent = 'La fecha de salida debe ser posterior a la fecha de entrada.';
                errorDiv.style.display = 'block';
                return false;
            } else {
                errorDiv.style.display = 'none';
                return true;
            }
        }
        return true;
    }

    // 🧠 Función AJAX para validar disponibilidad en el servidor
    async function checkAvailability() {
        if (!validateDates()) return;

        const formData = new FormData();
        formData.append('checkin', checkin.value);
        formData.append('checkout', checkout.value);

        try {
            const response = await fetch(`/booking/{{ booking.id }}/check-dates/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            const data = await response.json();

            if (!data.available) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        } catch (err) {
            console.error('Error al verificar disponibilidad:', err);
        }
    }

    // Eventos
    checkin.addEventListener('change', () => {
        checkout.min = checkin.value;
        checkAvailability();
    });

    checkout.addEventListener('change', checkAvailability);

    form.addEventListener('submit', function(e) {
        if (!validateDates()) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}