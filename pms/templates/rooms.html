{% extends "main.html" %}

{% block content %}
<h1>Habitaciones del hotel</h1>

<!-- Search form -->
<form id="room-search-form" class="mb-4">
    <input 
        type="text" 
        id="search-input" 
        name="q" 
        placeholder="Buscar habitación por nombre..." 
        class="form-control"
        autocomplete="off"
    />
</form>

<!-- Container where rooms are rendered
This div is filled dynamically with the search results -->
<div id="rooms-container">
    {% for room in rooms %}
    <div class="room-card row card mt-3 mb-3 hover-card bg-tr-250">
        <div class="col p-3">
            <div>{{ room.name }} ({{ room.room_type__name }})</div>
            <div>
                <a href="{% url 'room_details' pk=room.id %}" class="btn btn-link p-0">Ver detalles</a>
            </div>
        </div>
    </div>
    {% empty %}
    <p>No hay habitaciones disponibles.</p>
    {% endfor %}
</div>

<!-- AJAX script    
This script allows to search rooms in real time-->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("search-input");
    const roomsContainer = document.getElementById("rooms-container");

    const initialRoomsHTML = roomsContainer.innerHTML; //Stores the initial content (to restore it if there is no search)

    // Function to search rooms by AJAX
    const fetchRooms = async (query) => {
        // If there is no search, restore the original list
        if (!query) {
            roomsContainer.innerHTML = initialRoomsHTML;
            return;
        }

        try {
            const response = await fetch(`{% url 'rooms' %}?q=${encodeURIComponent(query)}`, {
                headers: { "X-Requested-With": "XMLHttpRequest" },
            });

            const data = await response.json();

            // Clear and render
            roomsContainer.innerHTML = data.rooms.length
                ? data.rooms.map(room => `
                    <div class="room-card row card mt-3 mb-3 hover-card bg-tr-250">
                        <div class="col p-3">
                            <div>${room.name} (${room.room_type__name})</div>
                            <div><a href="/room/${room.id}/" class="btn btn-link p-0">Ver detalles</a></div>
                        </div>
                    </div>
                `).join("")
                : "<p>No hay habitaciones que coincidan con la búsqueda.</p>";

        } catch (error) {
            console.error("Error al buscar habitaciones:", error);
            roomsContainer.innerHTML = "<p class='text-danger'>Error al cargar las habitaciones.</p>";
        }
    };

    // Listen to the input event for real-time search
    searchInput.addEventListener("input", (e) => {
        fetchRooms(e.target.value.trim());
    });
});
</script>

{% endblock content %}
